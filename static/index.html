<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chirm</title>
  <link rel="stylesheet" href="/css/app.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7c6af5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>

<div id="sidebar-overlay"></div>
<div id="app">

  <!-- â”€â”€â”€ LEFT SIDEBAR â”€â”€â”€ -->
  <div id="sidebar">
    <div id="server-header" class="server-header-expanded">
      <div id="server-header-main" onclick="toggleServerInfo()">
        <div id="server-icon-wrap">
          <div id="server-icon-display"></div>
        </div>
        <div id="server-header-text">
          <span id="server-name">Chirm</span>
        </div>
        <span class="chevron" id="server-chevron">â–¾</span>
      </div>
      <div id="server-info-bar">
        <span id="server-description" class="server-description"></span>
        <button class="server-info-btn" onclick="openServerRules()" title="Server Rules & Info">â„¹</button>
      </div>
    </div>

    <div id="channels-list">
      <!-- Populated by JS -->
    </div>

    <!-- â”€â”€â”€ VOICE STATUS BAR (shown while in a call) â”€â”€â”€ -->
    <div id="voice-status-bar" style="display:none">
      <div id="vsb-info">
        <div id="vsb-status-text">
          <span class="vsb-live-dot"></span>
          <span id="vsb-channel-label">Voice Connected</span>
        </div>
      </div>
      <div id="vsb-controls">
        <button id="vsb-mic"    class="vsb-btn active" onclick="Voice.toggleMic()"         title="Mute Mic"><span>ğŸ™</span></button>
        <button id="vsb-deaf"   class="vsb-btn"        onclick="Voice.toggleDeafen()"      title="Deafen"><span>ğŸ”ˆ</span></button>
        <button id="vsb-cam"    class="vsb-btn"        onclick="Voice.toggleCam()"         title="Toggle Camera"><span>ğŸ“·</span></button>
        <button id="vsb-screen" class="vsb-btn"        onclick="Voice.toggleScreenShare()" title="Share Screen"><span>ğŸ–¥</span></button>
        <button id="vsb-leave"  class="vsb-btn vsb-leave" onclick="Voice.leave()"          title="Leave Voice"><span>ğŸ“µ</span></button>
      </div>
    </div>

    <div id="user-panel">
      <div id="user-info" class="flex-center gap-8">
        <!-- Populated by JS -->
      </div>
      <div id="user-panel-actions">
        <button onclick="openProfile()" title="Edit Profile">âš™</button>
        <button onclick="ChirmSettings.openSettingsModal()" title="Notification Settings" id="notif-settings-btn">ğŸ””</button>
        <button id="admin-btn" onclick="openAdmin()" title="Admin Panel" style="display:none">ğŸ›¡</button>
        <button onclick="logout()" title="Logout">â»</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ MAIN CONTENT â”€â”€â”€ -->
  <div id="main">
    <div id="channel-header">
      <button id="hamburger-btn" onclick="toggleSidebar()" title="Toggle Menu">â˜°</button>
      <span class="ch-hash">#</span>
      <span id="ch-title" class="ch-title">Select a channel</span>
      <span id="ch-desc" class="ch-desc"></span>
      <div id="channel-header-actions">
        <button title="Members" onclick="toggleMembers()">ğŸ‘¥</button>
      </div>
    </div>

    <div id="messages-container">
      <div id="messages-list">
        <div class="empty-state" style="padding-top:120px">
          <div class="empty-icon">âœ¦</div>
          <h3>Welcome to Chirm</h3>
          <p>Select a channel to start chatting.</p>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ VOICE ROOM PANEL â”€â”€â”€ -->
    <div id="voice-panel" style="display:none"></div>

    <div id="typing-indicator"></div>

    <!-- Reply bar -->
    <div id="reply-bar" style="display:none">
      <span class="reply-bar-icon">â†© Replying to</span>
      <span class="reply-bar-author"></span>
      <span class="reply-bar-content"></span>
      <button class="reply-bar-cancel" onclick="clearReply()" title="Cancel reply">âœ•</button>
    </div>

    <!-- Upload preview strip -->
    <div id="upload-preview" style="display:none;padding:8px 16px 0;align-items:center;gap:10px;background:var(--bg-base)"></div>

    <div id="message-input-area">
      <form id="message-form">
        <input type="file" id="file-input" style="display:none" accept="image/*,video/*,audio/*,.pdf,.txt,.zip">
        <button type="button" id="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach file">ğŸ“</button>
        <button type="button" id="emoji-btn" onclick="openInputEmojiPicker(event)" title="Insert emoji">ğŸ˜Š</button>
        <textarea id="message-input" rows="1" placeholder="Select a channel firstâ€¦"></textarea>
        <button type="submit" id="send-btn" title="Send message">â¤</button>
      </form>
    </div>
  </div>

  <!-- â”€â”€â”€ MEMBERS SIDEBAR â”€â”€â”€ -->
  <div id="members-sidebar">
    <div id="members-list">
      <!-- Populated by JS -->
    </div>
  </div>

</div>

<!-- â”€â”€â”€ ADMIN MODAL â”€â”€â”€ -->
<div id="admin-modal" class="modal-overlay" style="display:none">
  <div class="modal" style="max-width:700px;width:95%">
    <div class="modal-header">
      <h2>âš™ Server Administration</h2>
      <button class="modal-close" onclick="closeModal('admin-modal')">âœ•</button>
    </div>
    <div class="modal-body" style="padding-top:0">
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="users" onclick="switchAdminTab('users')">Users</button>
        <button class="admin-tab" data-tab="roles" onclick="switchAdminTab('roles')">Roles</button>
        <button class="admin-tab" data-tab="invites" onclick="switchAdminTab('invites')">Invites</button>
        <button class="admin-tab" data-tab="emojis" onclick="switchAdminTab('emojis')">Emoji</button>
        <button class="admin-tab" data-tab="settings" onclick="switchAdminTab('settings')">Settings</button>
      </div>

      <div id="admin-pane-users" class="admin-pane active">
        <div id="admin-users-list">Loadingâ€¦</div>
      </div>

      <div id="admin-pane-roles" class="admin-pane">
        <div id="admin-roles-list">Loadingâ€¦</div>
      </div>

      <div id="admin-pane-invites" class="admin-pane">
        <div id="admin-invites-list">Loadingâ€¦</div>
      </div>

      <div id="admin-pane-emojis" class="admin-pane">
        <div id="admin-emojis-list">Loadingâ€¦</div>
      </div>

      <div id="admin-pane-settings" class="admin-pane">
        <div id="admin-settings-form">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ TOAST CONTAINER â”€â”€â”€ -->
<div id="toast-container"></div>

<script src="/js/ws.js"></script>
<script src="/js/voice.js"></script>
<script src="/js/emoji-data.js"></script>
<script src="/js/cache.js"></script>
<script src="/js/user-settings.js"></script>
<script src="/js/notifications.js"></script>
<script src="/js/mentions.js"></script>
<script src="/js/app.js"></script>
<script>
  // Register Service Worker (v2 â€” fixes navigation caching / login loop)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        // Unregister any old SW first to ensure clean slate on cache changes
        const existing = await navigator.serviceWorker.getRegistration('/');
        if (existing) {
          const controller = existing.active;
          if (controller) {
            // Check if it's an old version by triggering an update check
            existing.update().catch(() => {});
          }
        }

        const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
        console.log('[Chirm] SW registered:', reg.scope);

        // If a new SW is waiting, tell it to take over immediately
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'skip-waiting' });
        }
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW?.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              newSW.postMessage({ type: 'skip-waiting' });
            }
          });
        });

        // Pass SW registration to notification system once App is ready
        const waitForApp = setInterval(() => {
          if (typeof ChirmNotifs !== 'undefined' && typeof App !== 'undefined' && App.user) {
            clearInterval(waitForApp);
            ChirmNotifs.init(reg);
          }
        }, 300);

        // Hard limit: if app takes > 10s to init, give up on the interval
        setTimeout(() => clearInterval(waitForApp), 10000);
      } catch (err) {
        console.warn('[Chirm] SW registration failed:', err);
      }
    });
  }
</script>
</body>
</html>
